## 传输层

a:传输层的服务

b:传输层寻址与端口号、无连接服务与面向连接服务

c:UDP传输协议

d:TCP传输协议

### 传输层的服务

1. 传输层为运行在不同主机上的**进程**之间提供了逻辑通信（即端到端的通信），端系统运行传输层协议。作为对比，网络层提供**主机**(host)之间的逻辑通信机制。传输层位于网络层之上，依赖于网络层服务，并对网络层服务进行封装和（可能的）增强。

2. 复用和分用
   - 复用：发送方不同的应用进程可以用同一个传输层协议传送数据
   - 分用：接收方的传输层在剥去报文的首部后能够把这些数据正确交付到目的应用进程
     - TCP的Socket用四元组(源IP地址、源端口号、目的IP、目的端口号)来标识

3. 对收到的报文进行差错检测（首部和数据部分）

4. 提供两种不同的传输协议：

   - 可靠、面向连接、按序的交付服务：TCP

   - 不可靠、无连接、尽力而为的交付服务：UDP
   - 两种服务均不保证延迟和带宽

### 传输层寻址与端口号、无连接服务与面向连接服务

端口是传输层服务访问点（TSAP），它的作用类似于链路层的MAC地址和网络层的IP地址，

端口号长度为16bit，能够表示65536个不同的端口号。0-49151为服务端使用的端口号，49152-65535为客户端使用。

其中0-1023为熟知端口号，1024-49151称为登记端口号；49152-65535又称短暂端口号。

| 应用程序   | FTP( 控制/数据 ) | TELNET | SMTP | DNS  | TFTP | HTTP | HTTPS |
| ---------- | ---------------- | ------ | ---- | ---- | ---- | ---- | ----- |
| 熟知端口号 | 21(20)           | 23     | 25   | 53   | 69   | 80   | 443   |

TCP提供的是面向连接的服务，UDP提供的是无连接服务。

### UDP传输协议

特点：无连接、首部开销小、最大努力交付、应用层要保证可靠性

首部：8B，分别为源端口号、目的端口号、长度、校验和

校验：checksum，检测传输中是否发生错误

- 发送方：以16bit为单位，采用首部、伪首部、数据进行二进制反码运算求和再取反
- 接收方：以16bit为单位，计算所有字段和是否为全1(0xFFFF)

应用：流媒体（可容忍丢失、对速率敏感）、DNS、SNMP

在UDP上实现可靠数据传输：在应用层增加可靠性机制以及特定的错误恢复机制

### TCP传输协议

特点：有连接、一对一、提供可靠交付、全双工通信、面向字节流

首部：20B、源端口、目的端口、序号、确认号等控制信息

连接管理：三次握手、四次挥手

可靠传输机制

- 序号：用来保证数据能有序提交给应用层
- 确认：确认号为期待收到的下一个报文的第一个字节的序号
- 重传
  - 超时：计时器到期还没收到确认则重传对应报文
  - 冗余确认：接受端收到失序报文时向发送端发送冗余ACK

流量控制：在确认报文中设置接收窗口`rwnd`的值来限制发送速率

拥塞控制

- 原理：根据自己估算的网络拥塞程度设置`cwnd`的值来限制发送速率
- 方法：
  - 慢开始：当`cwnd < sshtresh`时，每收到一个报文段的确认`cwnd`加1
  - 拥塞避免：当`cwnd > sshtresh`时，每经过一个RTT，`cwnd`加1
  - 快重传：当收到连续的3个冗余ACK，直接重传对方期待的报文
  - 快恢复：当收到连续的3个冗余ACK，令`ssthresh = cwnd = cwnd/2`
- 超时：`ssthresh`置为原`cwnd`的一半，`cwnd`置1
- 连续收到3个ACK：`ssthresh`置为原`cwnd`的一半，令`ssthresh = cwnd = cwnd/2`



### 可靠数据传输

#### Rdt1.0

假设底层信道完全可靠，发送方和接收方的FSM(finite state machine)独立。

#### Rdt2.0

背景：底层信道可能反转分组中的位

引入的措施：

- 差错检测
- 接收方反馈控制信息：ACK/NAK
- 重传

仍然存在的问题

- 发送方无法对ACK进行校验
- 简单地重传会出现重复分组的问题

如何解决

- 引入序列号，接收方丢弃收到的重复分组



#### Rdt3.0

信道既可能发生错误，也可能丢失分组

- 发送方等待“合理”的时间
- 如果没有收到确认则重传

性能

- 因为停-等，需要等待2RTT才能发送新的分组，信道利用率极低

改进

- 采用流水线，提高信道利用率

#### 滑动窗口

**信道利用率**= N*传输延迟 / (RTT + 一个发送帧的传输延迟 + 确认帧的传输延迟)

